# 認証

## 概要
管理者認証とユーザーセッション管理の実装方針。

---

## 管理者認証（Basic認証）

### 実装方法
Next.js Middlewareを使用してBasic認証を実装。

**仕組み:**
1. `/admin`配下へのリクエストをMiddlewareで検査
2. `Authorization`ヘッダーの有無を確認
3. Base64デコードしてユーザー名とパスワードを検証
4. 環境変数と照合して認証成功/失敗を判定

**Middlewareの役割:**
- `/admin`パスのみに適用
- 認証情報がない、または無効な場合は401レスポンス
- `WWW-Authenticate`ヘッダーでブラウザのBasic認証ダイアログを表示

### 環境変数設定

**ローカル開発:**
`.env.local`に以下を追加:
```
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your_secure_password
```

**本番環境（Vercel）:**
- Vercel Dashboardで環境変数を設定
- `ADMIN_USERNAME`と`ADMIN_PASSWORD`を追加
- 本番用に強力なパスワードを設定

**セキュリティ推奨事項:**
- パスワードは複雑なものを使用（20文字以上推奨）
- パスワードマネージャーで生成・管理
- 定期的にパスワードをローテーション

---

## ユーザーセッション管理

### Cookieベースのセッション

**仕組み:**
1. ユーザーが初回アクセス時にセッションIDを生成（UUID v4）
2. セッションIDをHTTPOnly Cookieに保存
3. 以降のリクエストで同じセッションIDを使用
4. ニックネーム登録時に`sessions`テーブルに保存

**Cookieの設定:**
- `httpOnly: true` - JavaScriptからアクセス不可（XSS対策）
- `secure: true`（本番環境） - HTTPS通信のみ
- `sameSite: 'lax'` - CSRF対策
- `maxAge: 7日間` - 有効期限

**セッションIDの生成:**
- UUID v4を使用して衝突を防止
- クライアント側ではなくサーバー側で生成

---

### ニックネーム登録

**フロー:**
1. ユーザーがニックネームを入力
2. Server Actionで重複チェックを実行
3. 同一イベント内で既に使用されている場合はエラー
4. 問題なければ`sessions`テーブルに保存
5. セッションIDとニックネームを紐付け

**重複チェックのロジック:**
- `event_id`と`nickname`の組み合わせで検索
- UNIQUE制約により、データベースレベルでも重複を防止

**エラーハンドリング:**
- 重複時: 「このニックネームは既に使用されています」
- DB接続エラー: エラーメッセージを返却
- クライアントでトースト通知を表示

---

## セキュリティ対策

### XSS対策
- **Next.jsのデフォルト機能:** HTML出力は自動的にエスケープ
- **ユーザー入力:** ニックネームなどの入力は全てエスケープされる
- **dangerouslySetInnerHTML:** 使用しない方針

### CSRF対策
- **Next.js Server Actions:** 自動的にCSRFトークンを検証
- **Cookie設定:** `sameSite: 'lax'`でクロスサイトリクエストを制限
- **追加対策:** 必要に応じてCSRFトークンを明示的に実装可能

### RLS（Row Level Security）
- **Supabase RLS:** データベースレベルでアクセス制御
- **ユーザーポリシー:** 自分のセッションと回答のみアクセス可能
- **管理者ポリシー:** 全データを参照可能（Basic認証で保護）

**主要なRLSポリシー:**
- `sessions`: ユーザーは自分のセッションのみ作成・参照
- `answers`: ユーザーは自分の回答のみ作成・参照
- `quiz_control`: 全員が読み取り可能、管理者のみ更新可能

---

## セッションの有効期限

### 自動延長
**仕組み:**
- ユーザーがアクティブな場合、`last_active_at`カラムを更新
- 定期的にハートビートリクエストを送信（オプション）
- クイズ回答時や画面遷移時に自動的に更新

**更新タイミング:**
- 回答送信時
- 画面遷移時
- 定期的なポーリング（5分ごと）

### クリーンアップ
**定期削除処理:**
- 古いセッションを定期的に削除するバッチ処理を実装
- Supabase Functionsでcronジョブを設定
- 7日間アクティビティがないセッションを削除

**削除対象:**
- `last_active_at`が7日以上前のレコード
- 関連する`answers`も自動削除（CASCADE）

**実装オプション:**
- Supabase Edge Functions（cron trigger）
- GitHub Actionsで定期実行
- Vercel Cron Jobs

---

最終更新: 2025年10月19日
