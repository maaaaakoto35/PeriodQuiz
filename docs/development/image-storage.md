# 画像ストレージ

## 概要
問題や選択肢の画像を保存・配信するためのストレージ設計。

---

## Supabase Storageの選定理由

| 項目 | Supabase Storage | AWS S3 | Vercel Blob |
|------|------------------|--------|-------------|
| **統合性** | Supabaseとネイティブ統合 | 別途AWSアカウント必要 | Vercelに統合 |
| **コスト** | 1GB無料（Free）, 100GB含む（Pro $25/月） | 従量課金 | 従量課金 |
| **CDN** | 自動CDN配信 | CloudFront設定必要 | 自動CDN配信 |
| **アクセス制御** | RLSとポリシー | IAMポリシー | トークンベース |
| **簡易性** | 高い | 中程度 | 高い |

本プロジェクトでは、Supabaseとの統合性とコストパフォーマンスを優先し、**Supabase Storage**を採用。

---

## バケット設計

### `quiz-images`バケット

**用途:**
- 問題画像
- 選択肢画像

**公開設定:**
- パブリック読み取り可能
- 管理者のみアップロード可能

**ディレクトリ構造:**
```
quiz-images/
├── questions/
│   ├── {question_id}.jpg
│   ├── {question_id}.png
│   └── ...
└── choices/
    ├── {choice_id}.jpg
    ├── {choice_id}.png
    └── ...
```

**命名規則:**
- ファイル名は対応するレコードのID（UUID）を使用
- 拡張子は元のファイル形式を保持（.jpg, .png, .webp等）
- 同じIDで再アップロードした場合は上書き（upsert）

---

## アップロード処理

### 管理画面からのアップロード

**フロー:**
1. ユーザーがファイル選択
2. クライアント側でファイルをSupabase Storageにアップロード
3. アップロード成功後、公開URLを取得
4. 公開URLを`questions`または`choices`テーブルの`image_url`カラムに保存

**アップロードオプション:**
- `upsert: true` - 既存ファイルを上書き
- `contentType` - MIMEタイプを明示的に指定（オプション）

**エラーハンドリング:**
- ファイルサイズ制限（推奨: 5MB以下）
- 対応形式チェック（jpg, png, webp, gif）
- アップロード失敗時はトースト通知

---

## 画像の取得と表示

### 公開URLの取得

**仕組み:**
1. Supabase Storage APIで`getPublicUrl()`を呼び出し
2. 返却されたURLは永続的な公開URL
3. このURLを`questions.image_url`や`choices.image_url`に保存
4. クライアント側で直接URLを参照して画像を表示

**CDN配信:**
- Supabase StorageはデフォルトでCDNを使用
- グローバルに高速配信が可能

---

### Next.js Imageコンポーネントでの表示

**メリット:**
- 自動的にWebP形式に変換
- レスポンシブ画像の生成
- 遅延読み込み（Lazy loading）
- プレースホルダー表示

**パフォーマンス最適化:**
- `width`と`height`を指定してレイアウトシフトを防止
- `priority`プロパティで重要な画像を優先読み込み
- `sizes`プロパティでレスポンシブブレークポイントを指定

---

## ストレージポリシー

### アクセス制御

**読み取りポリシー:**
- 全員が`quiz-images`バケットの画像を読み取り可能
- クイズ参加者が問題画像を表示するために必要

**書き込みポリシー:**
- 管理者のみアップロード、更新、削除が可能
- MiddlewareのレイヤーでBasic認証により保護

**RLSとの連携:**
- Supabase StorageのポリシーはRLSと同様の仕組み
- `bucket_id`でバケットごとにポリシーを設定

---

## 画像の最適化

### Next.js Image Optimization
**自動最適化機能:**
- WebP形式への変換
- サイズ別の複数画像生成（srcset）
- デバイスに応じた最適な画像配信
- 画質の自動調整

**設定:**
- `next.config.js`で外部ドメイン（Supabase Storage）を許可
- `remotePatterns`でSupabaseのドメインを追加

---

### アップロード前の圧縮（オプション）

**推奨ライブラリ:**
- `browser-image-compression` - クライアント側で画像圧縮

**圧縮設定例:**
- 最大ファイルサイズ: 1MB
- 最大幅/高さ: 1920px
- Web Workerを使用してメインスレッドをブロックしない

**メリット:**
- ストレージ容量の節約
- アップロード時間の短縮
- ユーザー体験の向上

---

## 容量管理

### Supabase Storageの制限
- **Free Tier:** 1GB
- **Pro Tier:** 100GB（超過分は従量課金）

**想定容量:**
- 120問 × 平均500KB = 60MB（問題画像）
- 選択肢画像を含めても100MB以内を想定
- Free Tierで十分対応可能

---

### モニタリング
**監視方法:**
- Supabase Dashboardでストレージ使用量を確認
- 定期的にレポートをチェック
- アラート設定（容量が80%を超えたら通知）

**ログ記録:**
- アップロード履歴を記録
- 容量の推移をトラッキング

---

### クリーンアップ

**自動削除:**
- 問題や選択肢が削除された場合、関連画像も削除
- `ON DELETE CASCADE`の動作に合わせてStorage APIで削除

**定期クリーンアップ:**
- 孤立した画像（DBレコードが存在しない）を検出
- Supabase Functionsで定期的にクリーンアップ処理を実行

**手動削除:**
- 管理画面から不要な画像を一括削除する機能を提供

---

最終更新: 2025年10月19日
