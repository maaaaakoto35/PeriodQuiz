# 001 - ユーザー参加とセッション管理

## 概要
ユーザーがクイズシステムに参加し、セッションを確立するための機能。

## ユーザーストーリー

### [US-001-01](https://github.com/maaaaakoto35/PeriodQuiz/pull/4): ユーザーの初回アクセス
**As a** user  
**I want to** システムにアクセスしてニックネームを入力する  
**So that** クイズに参加できる

#### 受け入れ基準
- [x] ユーザーが初回アクセス時にニックネーム入力画面が表示される
- [x] ニックネームは1文字以上20文字以内で入力できる
- [x] ニックネームに使用できる文字種を制限する（例: 英数字、ひらがな、カタカナ、漢字）
- [x] **重複するニックネームの入力を防ぐ（同じニックネームは許容しない）**
- [x] ニックネーム入力後、セッションが確立される
- [x] セッション確立後、待機画面に遷移する
- [x] **クイズ開始後は新規ユーザーの登録（ニックネーム入力）ができない**

#### 技術的考慮事項
- セッションIDはサーバー側で生成
- セッションとニックネームの紐付けをデータベースまたはインメモリストレージで管理
- セッションの有効期限を設定（例: クイズ終了まで、または24時間）

---

### US-001-02: セッションの維持
**As a** user  
**I want to** ページをリロードしてもセッションが維持される  
**So that** 進行中のクイズに継続して参加できる

#### 受け入れ基準
- [x] ブラウザのリロード後もセッションが維持される
- [x] セッションが有効な場合、ニックネーム入力をスキップして現在の画面に戻る
- [x] **クイズ途中でリロードしても、セッションが保たれていれば復活可能**
- [x] セッションが無効な場合、ニックネーム入力画面に戻る（ただしクイズ開始後は登録不可）

#### 技術的考慮事項
- Cookie、LocalStorage、またはSessionStorageを使用
- サーバー側でセッションの有効性を検証

---

### US-001-03: 管理者による参加者一覧の確認
**As an** admin  
**I want to** 現在参加しているユーザーの一覧を確認する  
**So that** 参加状況を把握できる

#### 受け入れ基準
- [x] admin画面のサイドバーに「ユーザー管理」メニューがある
- [x] 「ユーザー管理」をクリックすると`/admin/users`に遷移し、ユーザー一覧が表示される
- [x] ユーザー一覧は15秒ごとに自動更新される
- [x] 表示項目（全イベント共通）:
  - ニックネーム
  - イベント名（複数イベント参加している場合はカンマ区切り）
  - セッション確立時刻（`users.created_at`）
  - 接続状態（**ハードコーディング：接続中/接続断で混在**）
- [x] 参加者数が表示される
- [x] ユーザーは`users.id`昇順でソートされている

#### 技術的考慮事項
- WebSocketまたはポーリングでリアルタイム更新
- 120人規模のユーザーを想定したパフォーマンス設計

---

### US-001-04: ユーザー画面のセッション確立
**As a** user  
**I want to** ページを開いた後、バックグラウンドで常にセッションを最新に保つ  
**So that** 自分がアクティブであることをシステムに知らせることができる

#### 受け入れ基準
- [x] ページロード時に`quiz_control`テーブルをリアルタイムで監視する（Supabase Realtime）
- [x] `quiz_control`の変更を検知したら、`users.last_active_at`を更新する
- [x] 定期的に`users.last_active_at`を更新して、セッションが有効であることを保証する（15秒ごと）

#### 技術的考慮事項
- Supabase Realtimeで`quiz_control`テーブルの変更を購読
- `users.last_active_at`の更新頻度は15秒に設定

#### 実装詳細
- **フック**: `useSessionHeartbeat` - Realtime監視と定期更新を管理
- **コンポーネント**: `WaitingPageContent` - セッションステータス表示
- **状態表示**: 接続中/更新中/エラーの3状態をインジケーターで表示

---

## 非機能要件
- **パフォーマンス**: 120人の同時アクセスに対応
- **可用性**: セッションの永続化または適切なフォールバック
- **セキュリティ**: セッションハイジャック対策

## 依存関係
- なし（最優先の基盤機能）

## 備考
- ログイン機能は不要
- ニックネームの一意性をどの範囲で担保するか（同一クイズイベント内のみ、など）を実装時に決定
