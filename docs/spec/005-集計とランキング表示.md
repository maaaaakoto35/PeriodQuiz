# 005 - 集計とランキング表示

## 概要
回答データを集計し、ランキングを生成・表示する機能。

## ユーザーストーリー

### US-005-01: ピリオドランキングの生成
**As a** system  
**I want to** ピリオド終了時にランキングを生成する  
**So that** ユーザーに結果を表示できる

#### 受け入れ基準
- [ ] ピリオド内の全ユーザーの成績を集計
- [ ] 集計項目:
  - ニックネーム
  - 正解数
  - 合計回答時間
- [ ] ソートルール: `正解数（降順） > 合計回答時間（昇順）`
- [ ] 同点の場合の順位付けを明確化（同順位 or 合計回答時間で差をつける）
- [ ] ランキングデータを保存

#### 技術的考慮事項
- SQL ORDER BY句での複数条件ソート
- 集計クエリのパフォーマンス最適化

---

### US-005-02: ピリオドチャンピオンの決定
**As a** system  
**I want to** ピリオドランキング1位のユーザーをチャンピオンとする  
**So that** ピリオドの勝者を明確にできる

#### 受け入れ基準
- [ ] ランキング1位のユーザーをピリオドチャンピオンとして記録
- [ ] チャンピオン情報を保存（ピリオドIDとユーザーIDの紐付け）

---

### US-005-03: 最終ランキングの生成
**As a** system  
**I want to** 全ピリオド終了時に最終ランキングを生成する  
**So that** イベント全体の結果を表示できる

#### 受け入れ基準
- [ ] 全ピリオドを通じた全ユーザーの成績を集計
- [ ] 集計項目:
  - ニックネーム
  - 全体正解数（全ピリオドの正解数の合計）
  - 全体合計回答時間（全ピリオドの回答時間の合計）
- [ ] ソートルール: `全体正解数（降順） > 全体合計回答時間（昇順）`
- [ ] 最終ランキングデータを保存

---

### US-005-04: 優勝者の決定
**As a** system  
**I want to** 最終ランキング1位のユーザーを優勝者とする  
**So that** イベントの勝者を明確にできる

#### 受け入れ基準
- [ ] 最終ランキング1位のユーザーを優勝者として記録
- [ ] 優勝者情報を保存（イベントIDとユーザーIDの紐付け）

---

### US-005-05: ユーザーへのランキング表示（ピリオド）
**As a** user  
**I want to** ピリオド集計結果画面でランキングを確認する  
**So that** 自分の成績とピリオドチャンピオンを知ることができる

#### 受け入れ基準
- [ ] ピリオド集計結果画面に以下を表示:
  - ピリオド名
  - ランキング（上位10位程度）
    - 順位
    - ニックネーム
    - 正解数 / 総問題数
    - 合計回答時間（秒単位、小数点以下1桁）
  - 自分の成績（ランキング外でも表示）
    - 自分の順位
    - 正解数 / 総問題数
    - 合計回答時間
  - チャンピオン（1位）の強調表示（背景色、王冠アイコンなど）

#### 技術的考慮事項
- 大規模ランキングの効率的な表示
- 自分の順位を素早く取得するクエリ

---

### US-005-06: ユーザーへのランキング表示（最終結果）
**As a** user  
**I want to** 最終結果画面で全体ランキングを確認する  
**So that** 自分の成績と優勝者を知ることができる

#### 受け入れ基準
- [ ] 最終結果画面に以下を表示:
  - イベント名
  - 全体ランキング（上位20位程度）
    - 順位
    - ニックネーム
    - 全体正解数 / 全問題数
    - 全体合計回答時間（秒単位、小数点以下1桁）
  - 自分の成績
    - 自分の順位
    - 全体正解数 / 全問題数
    - 全体合計回答時間
  - 優勝者（1位）の特別な強調表示
  - 各ピリオドのチャンピオン一覧
    - ピリオド名
    - チャンピオンのニックネーム

#### 技術的考慮事項
- 過去のピリオドデータの効率的な取得

---

### US-005-07: adminへのリアルタイム集計表示
**As an** admin  
**I want to** クイズ進行中にリアルタイムで集計結果を確認する  
**So that** 進行状況を把握できる

#### 受け入れ基準
- [ ] admin画面に以下の情報が常時表示される:
  - 現在のピリオドの暫定ランキング（上位10位程度）
    - 順位
    - ニックネーム
    - 現時点の正解数
    - 現時点の合計回答時間
  - 各問題の正解率
    - 問題番号
    - 回答者数 / 全ユーザー数
    - 正解率（%）
    - 各選択肢の選択率
- [ ] 情報は新しい回答が入るたびに更新される

#### 技術的考慮事項
- リアルタイム集計のパフォーマンス
- WebSocketまたはポーリングでの更新

---

### US-005-08: 同点時の順位処理
**As a** system  
**I want to** 正解数が同じ場合は合計回答時間で順位を決定する  
**So that** 公平にランキングを作成できる

#### 受け入れ基準
- [ ] 正解数が同じ場合、合計回答時間が短い方が上位
- [ ] **正解数も合計回答時間も同じ場合は同立順位とする**
  - 回答時間はミリ秒単位で計測されるため、完全一致はまれ
  - 完全一致した場合は同じ順位を表示

#### 技術的考慮事項
- ソートアルゴリズムの実装
- 同順位の場合、次の順位は飛ばす（例: 1位が2人いる場合、次は3位）

---

## 非機能要件
- **パフォーマンス**: 120人のランキング生成を5秒以内に完了
- **正確性**: 集計結果に誤りがないこと
- **リアルタイム性**: admin画面の集計は3秒以内に更新

## 依存関係
- 004 回答記録と時間計測

## 備考
- キャッシュ戦略の検討（頻繁な集計クエリのパフォーマンス向上）
- 将来的には詳細な統計情報（問題別正解率、ユーザー別推移など）の表示も検討
