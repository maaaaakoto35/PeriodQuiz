# 003 - 画面遷移制御

## 概要
管理者がユーザーの画面を一斉に制御し、クイズの進行を管理する機能。
ユーザーの画面はオールスター感謝祭のクイズを模す。

## ユーザーストーリー

### US-003-01: イベントのステータスのリファクタリング
**As an** admin
**I want to** イベントのステータス管理を保守しやすい形に変更する
**So that** quiz_controlにイベントのステータス管理を移譲する

#### 受け入れ基準
- [x] イベントのステータス管理が全てquiz_controlに移譲されていること
- [x] 既存のステータス管理がquiz_controlを参照するようになっていること
- [x] admin画面でイベント一覧から画面制御への導線があること
- [x] 画面制御の画面では `current_screen` の制御ボタンを用いてステータスを変更できるようになっていること
  - [x] 制御ボタンを押下するとステータスの変更に加え、`current_period_id` と `current_question_id` が更新されること
    - `current_period.period_questions.order_num` を参照し、`current_question`よりも大きいquestionがない場合は、次のperiodを`current_period`にする
    - `current_period.period_questions.order_num` を参照し、`current_question`よりも大きいquestionがある場合は、次のquestionを`current_question`にする
    - `current_screen`が`period_result`になった場合に↑のロジックとは関係なく強制的に次のピリオドに移行する(`current_period`の更新と`current_question`の更新)
  - [x] `current_screen`が`question`になった場合に`question_displays`がinsertされること
  - [x] `current_screen`が`answer`になった場合にすでにある`question_displays.closed_at`が更新されること
  - このストーリーでは実装しないが、後々制御セクションの下にユーザーに出ている画面がpreviewされるようにする予定

#### 技術的考慮事項
- eventsのステータスは全て `quiz_control.current_screen` で行う
  - waiting -> ユーザーの登録可能、登録後は待機画面に遷移
  - question -> current_question_idの問題回答画面(問題も表示されている)
  - answer -> current_question_idの正解発表画面
  - break -> 次の問題に行くまでの待機画面
  - period_result -> current_period_idの結果画面
  - final_result -> 紐づいているevent_idの最終結果画面
- `events.allow_registration` は削除し、`quiz_control.current_screen` がwaitingの時のみユーザーの登録が可能にする

---

### US-003-02: クイズ問題表示と回答受付
**As an** admin  
**I want to** 特定のクイズ問題を全ユーザーに表示する  
**So that** 同時に問題を解かせることができる

#### 受け入れ基準
- [x] admin画面から「次の問題へ」ボタンをクリックできる
- [x] 全ユーザーの画面にクイズ問題が表示される
- [x] ユーザー画面の表示内容:
  - 問題番号（例: "第1ピリオド 問題3/15"）
  - 問題文
  - **問題画像（ある場合）**
  - 選択肢（2〜4個）
  - **各選択肢の画像（ある場合）**
  - 回答ボタン
- [x] ユーザーは選択肢を1つ選んで回答できる
- [x] 回答後は選択を変更できない
- [x] 回答済みの場合、その旨が表示される（「回答済み」等）
- [x] 未実装の`quiz_control.current_screen`の場合は未実装画面が表示される(ここでは`waiting`と`question`のみ実装済みの画面が表示されるイメージ)

#### 技術的考慮事項
- 問題表示時刻を記録（回答時間計測の開始点）
- 回答データ（ユーザーID、問題ID、選択肢、回答時刻）を保存
- `answers.response_time_ms` はサーバー側で計算し、`現在時刻 - question_displays.displayed_at`の値を入れること

---

### US-003-03: 正解発表画面の表示
**As an** admin  
**I want to** 問題の正解を全ユーザーに表示する  
**So that** ユーザーが自分の回答結果を確認できる

#### 受け入れ基準
- [ ] admin画面から「正解発表へ」ボタンをクリックできる
- [ ] 全ユーザーの画面に正解発表が表示される
- [ ] 表示内容:
  - 問題文
  - 全選択肢（正解にマーク表示）
  - 自分の選択した選択肢（正解/不正解の表示）
  - 回答時間（秒単位）
- [ ] 未回答だった場合、その旨が表示される
- [ ] 以下のユーザーは次の画面にいけず、`quiz_control.current_period_id`が変わるまで脱落画面が表示される
  - [ ] 未回答のユーザー
  - [ ] 正解を選べなかったユーザー

#### 技術的考慮事項
- 正解データの取得
- 個々のユーザーの回答結果の表示

---

### US-003-04: ピリオド終了画面の表示
**As an** admin  
**I want to** ピリオドを終了し、終了画面を表示する  
**So that** 次のステップに進むことができる

#### 受け入れ基準
- [ ] admin画面から以下の操作ができる:
  - 「ピリオドを強制終了」ボタン
  - ピリオド内の全問題が終了した場合、自動的に終了画面へ
- [ ] 全ユーザーの画面にピリオド終了画面が表示される
- [ ] 表示内容:
  - ピリオド名
  - 「集計中...」等のメッセージ
- [ ] admin画面から「集計結果へ」ボタンで次に進める

#### 技術的考慮事項
- ピリオドの状態管理（進行中/終了）

---

### US-003-05: ピリオド集計結果画面の表示
**As an** admin  
**I want to** ピリオドの集計結果を全ユーザーに表示する  
**So that** ピリオドのチャンピオンを発表できる

#### 受け入れ基準
- [ ] admin画面から「集計結果表示へ」ボタンをクリックできる
- [ ] 全ユーザーの画面に集計結果が表示される
- [ ] 表示内容:
  - ピリオド名
  - ランキング（上位10位程度）
    - 順位
    - ニックネーム
    - 正解数
    - 合計回答時間
  - 自分の順位と成績（ランキング外でも表示）
  - チャンピオン（1位）の強調表示

#### 技術的考慮事項
- ランキングのソート: `正解数（降順） > 合計回答時間（昇順）`
- 同点時の処理

---

### US-003-06: 最終結果待機画面の表示
**As an** admin  
**I want to** 全ピリオド終了後に最終結果待機画面を表示する  
**So that** 全体の集計を行える

#### 受け入れ基準
- [ ] 全ピリオド終了後、admin画面から「最終結果待機へ」ボタンをクリックできる
- [ ] 全ユーザーの画面に最終結果待機画面が表示される
- [ ] 表示内容:
  - 「全ピリオド終了！最終集計中...」等のメッセージ

---

### US-003-07: 最終結果画面の表示
**As an** admin  
**I want to** 全ピリオドを通じた最終結果を表示する  
**So that** 優勝者を発表できる

#### 受け入れ基準
- [ ] admin画面から「最終結果表示へ」ボタンをクリックできる
- [ ] 全ユーザーの画面に最終結果が表示される
- [ ] 表示内容:
  - イベント名
  - 全体ランキング（上位20位程度）
    - 順位
    - ニックネーム
    - 全体正解数
    - 全体合計回答時間
  - 自分の順位と成績
  - 優勝者（1位）の特別な強調表示
  - 各ピリオドのチャンピオン一覧

#### 技術的考慮事項
- 全ピリオドを横断した集計
- ランキングのソート: `全体正解数（降順） > 全体合計回答時間（昇順）`

---

### US-003-08: admin画面での進行状況確認
**As an** admin  
**I want to** 現在の進行状況を確認する  
**So that** 適切なタイミングで次に進める

#### 受け入れ基準
- [ ] admin画面に以下の情報が表示される:
  - 現在の画面状態（待機中、問題表示中、正解発表中など）
  - 現在のピリオド名と問題番号
  - 回答済みユーザー数 / 全ユーザー数
  - 未回答ユーザーのリスト（ニックネーム）
- [ ] 情報はリアルタイムで更新される

#### 技術的考慮事項
- WebSocketまたはポーリングによるリアルタイム更新

---

## 非機能要件
- **リアルタイム性**: 画面遷移は3秒以内に全ユーザーに反映
- **同期精度**: 120人が同時にアクセスしても画面が同期される
- **障害回復**: ネットワーク切断から復帰したユーザーが正しい画面に復帰できる

## 依存関係
- 001 ユーザー参加とセッション管理
- 002 クイズとピリオドの管理

## 備考
- WebSocketの実装が推奨される
- フォールバックとしてロングポーリングも検討
