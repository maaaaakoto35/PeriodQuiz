# 003 - 画面遷移制御

## 概要
管理者がユーザーの画面を一斉に制御し、クイズの進行を管理する機能。
ユーザーの画面はオールスター感謝祭のクイズを模す。

## ユーザーストーリー

### US-003-01: イベントのステータスのリファクタリング
**As an** admin
**I want to** イベントのステータス管理を保守しやすい形に変更する
**So that** quiz_controlにイベントのステータス管理を移譲する

#### 受け入れ基準
- [x] イベントのステータス管理が全てquiz_controlに移譲されていること
- [x] 既存のステータス管理がquiz_controlを参照するようになっていること
- [x] admin画面でイベント一覧から画面制御への導線があること
- [x] 画面制御の画面では `current_screen` の制御ボタンを用いてステータスを変更できるようになっていること
  - [x] 制御ボタンを押下するとステータスの変更に加え、`current_period_id` と `current_question_id` が更新されること
    - `current_period.period_questions.order_num` を参照し、`current_question`よりも大きいquestionがない場合は、次のperiodを`current_period`にする
    - `current_period.period_questions.order_num` を参照し、`current_question`よりも大きいquestionがある場合は、次のquestionを`current_question`にする
    - `current_screen`が`period_result`になった場合に↑のロジックとは関係なく強制的に次のピリオドに移行する(`current_period`の更新と`current_question`の更新)
  - [x] `current_screen`が`question`になった場合に`question_displays`がinsertされること
  - [x] `current_screen`が`answer`になった場合にすでにある`question_displays.closed_at`が更新されること
  - このストーリーでは実装しないが、後々制御セクションの下にユーザーに出ている画面がpreviewされるようにする予定

#### 技術的考慮事項
- eventsのステータスは全て `quiz_control.current_screen` で行う
  - waiting -> ユーザーの登録可能、登録後は待機画面に遷移
  - question -> current_question_idの問題回答画面(問題も表示されている)
  - answer -> current_question_idの正解発表画面
  - break -> 次の問題に行くまでの待機画面
  - period_result -> current_period_idの結果画面
  - final_result -> 紐づいているevent_idの最終結果画面
- `events.allow_registration` は削除し、`quiz_control.current_screen` がwaitingの時のみユーザーの登録が可能にする

---

### US-003-02: クイズ問題表示と回答受付
**As an** admin  
**I want to** 特定のクイズ問題を全ユーザーに表示する  
**So that** 同時に問題を解かせることができる

#### 受け入れ基準
- [x] admin画面から「次の問題へ」ボタンをクリックできる
- [x] 全ユーザーの画面にクイズ問題が表示される
- [x] ユーザー画面の表示内容:
  - 問題番号（例: "第1ピリオド 問題3/15"）
  - 問題文
  - **問題画像（ある場合）**
  - 選択肢（2〜4個）
  - **各選択肢の画像（ある場合）**
  - 回答ボタン
- [x] ユーザーは選択肢を1つ選んで回答できる
- [x] 回答後は選択を変更できない
- [x] 回答済みの場合、その旨が表示される（「回答済み」等）
- [x] 未実装の`quiz_control.current_screen`の場合は未実装画面が表示される(ここでは`waiting`と`question`のみ実装済みの画面が表示されるイメージ)

#### 技術的考慮事項
- 問題表示時刻を記録（回答時間計測の開始点）
- 回答データ（ユーザーID、問題ID、選択肢、回答時刻）を保存
- `answers.response_time_ms` はサーバー側で計算し、`現在時刻 - question_displays.displayed_at`の値を入れること

---

### US-003-03: 正解発表画面の表示
**As an** admin
**I want to** 問題の正解を全ユーザーに表示する
**So that** ユーザーが自分の回答結果を確認できる

#### 受け入れ基準
- [x] admin画面から「正解発表へ」ボタンをクリックできる
- [x] 全ユーザーの画面に正解発表が表示される
- [x] 表示内容:
  - 問題文
  - 全選択肢（正解にマーク表示）
  - 自分の選択した選択肢（正解/不正解の表示）
  - 回答時間（秒単位）
- [x] 未回答だった場合、その旨が表示される
- [x] 未回答もしくは不正解だった場合も脱落はせず、次の問題も解答ができる

#### 技術的考慮事項
- 正解データの取得
- 個々のユーザーの回答結果の表示

---

### US-003-04: 休憩画面の表示
**As an** admin
**I want to** 休憩画面を全ユーザーに表示する
**So that** ユーザーは自動的に休憩画面が表示される

#### 受け入れ基準
- [ ] admin画面から「休憩へ」ボタンをクリックできる
- [x] admin画面のイベント詳細から休憩画面に表示する画像を複数枚設定できる
- [ ] 全ユーザーの画面に休憩画面が表示される
- [x] 休憩画面ではadmin画面で設定した休憩画像がランダムで表示される(5秒ごとに画像が切り替わる)
  - [x] 設定されていない場合は不自然にならないような画面を表示する
- [x] 休憩画像は白枠で囲まれたカード形式で表示される
- [x] コーヒーアイコン（☕）と「休憩中」テキストが表示される
- [x] 背景画像は `public/quiz_background.jpeg` を使用
- [x] ページネーション表示（複数画像の場合）
- [x] Server Component で画像取得、Client Component でローテーション

#### 技術的考慮事項
- [x] 既存の `quiz-images` バケットを `images` に変更、`uploadQuizImage`のシグネチャを修正してfilePathを引数で受け取る形に変更
  - [x] ドキュメント系も修正する
- [x] BreakScreen: Server Component でサーバー側でデータ取得
- [x] BreakScreenClient: Client Component でランダムローテーション（5秒インターバル）
- [x] useBreakImageRotation: ランダムシャッフル＆ローテーションロジック
- [ ] 正解データの取得
- [ ] 個々のユーザーの回答結果の表示

---

### US-003-05: リセット機能
**As an** admin
**I want to** イベントのリセットができる
**So that** ユーザーの回答や問題表示の記録を削除する

#### 受け入れ基準
- [x] admin画面の画面制御から「リセット」ボタンをクリックできる
- [x] リセットをするとユーザーの回答や問題表示の記録が削除され、再度待機状態に変わる
- [x] 「リセット」を押下すると確認が入り、データが削除される旨が表示される

#### 技術的考慮事項
- イベントの画面制御でリセットを押すと以下になる
  - quiz_controlが`waiting`に変更される
  - イベントに紐づく`question_displays`の行が全て削除される
  - イベントに紐づく`answers`の行が全て削除される

---

### US-003-06: ピリオド集計結果画面の表示
**As an** admin
**I want to** ピリオドの集計結果を全ユーザーに表示する
**So that** ピリオドのチャンピオンを発表できる

#### 受け入れ基準
- [x] admin画面から「ピリオド結果へ」ボタンをクリックできる
- [x] 全ユーザーの画面に集計結果が表示される
- [x] 表示内容:
  - [x] ピリオド名
  - [x] ランキング（上位10位程度）
    - [x] 順位
    - [x] ニックネーム
    - [x] 正解数
    - [x] 合計回答時間
  - [x] 自分の順位と成績（ランキング外でも表示）
  - [x] チャンピオン（1位）の強調表示

#### 技術的考慮事項
- ランキングのソート: `正解数（降順） > 合計回答時間（昇順）`
- 同点時の処理
- US-003-08ではadmin画面でピリオド結果画面に行く前から現在のピリオドの上位10位が分かるようにするため、再利用性や冪等性を考慮すること

---

### US-003-07: 最終結果画面の表示
**As an** admin
**I want to** 全ピリオドを通じた最終結果を表示する
**So that** 優勝者を発表できる

#### 受け入れ基準
- [x] admin画面から「最終結果表示へ」ボタンをクリックできる
- [x] 全ユーザーの画面に最終結果が表示される
- [x] 表示内容:
  - [x] イベント名
  - [x] 全体ランキング（上位20位程度）
    - [x] 順位
    - [x] ニックネーム
    - [x] 全体正解数
    - [x] 全体合計回答時間
  - [x] 自分の順位と成績
  - [x] 優勝者（1位）の特別な強調表示
  - [x] 各ピリオドのチャンピオン一覧

#### 技術的考慮事項
- [x] 全ピリオドを横断した集計
- [x] ランキングのソート: `全体正解数（降順） > 全体合計回答時間（昇順）`
- [x] US-003-08ではadmin画面でピリオド結果画面に行く前から現在のピリオドの上位10位が分かるようにするため、再利用性や冪等性を考慮すること

---

### US-003-08: admin画面での進行状況確認
**As an** admin
**I want to** 現在の進行状況を確認する
**So that** 適切なタイミングで次に進める

#### 受け入れ基準
- [x] admin画面に以下の情報が表示される:
  - 現在の画面状態（待機中、問題表示中、正解発表中など）
  - 現在のピリオド名と問題番号
  - 回答済みユーザー数
  - 現在のピリオドの上位10位の正解数とピリオドの合計解答時間
  - 全体ランキングの上位10位の正解数と全クイズの合計解答時間
- [x] 情報は5秒ごとに更新される

#### 技術的考慮事項
- Supabase Realtimeを用いてランキングデータを取得する

---

### US-003-09: [仕様変更] 待機画面以降もユーザー登録ができるようにする
**As an** user
**I want to** クイズが進行している状態でもユーザー登録ができる
**So that** ユーザー登録ができるかどうかのロジックを変更する

#### 受け入れ基準
- [x] 待機画面以降でも新しいユーザーがイベントに参加できる
- [x] 登録前に終了したクイズに関しては、ランキング集計時には未回答のユーザーと同様の扱いにする

---

### US-003-10: admin画面での参加者数をリアルタイムで確認できるようにする
**As an** admin
**I want to** リアルタイムでイベントの参加者数を確認できるようにしたい
**So that** 画面制御でリアルタイムに参加者数を確認する

#### 受け入れ基準
- [x] admin画面の画面制御でイベントの参加者数がリアルタイムで更新される

#### 技術的考慮事項
- Supabase Realtimeを利用する

---

## 非機能要件
- **リアルタイム性**: 画面遷移は3秒以内に全ユーザーに反映
- **同期精度**: 120人が同時にアクセスしても画面が同期される
- **障害回復**: ネットワーク切断から復帰したユーザーが正しい画面に復帰できる

## 依存関係
- 001 ユーザー参加とセッション管理
- 002 クイズとピリオドの管理

## 備考
- WebSocketの実装が推奨される
- フォールバックとしてロングポーリングも検討
