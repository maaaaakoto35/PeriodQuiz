# 004 - 回答記録と時間計測

## 概要
ユーザーの回答を記録し、回答時間を正確に計測する機能。

## ユーザーストーリー

### US-004-01: 回答の記録
**As a** system  
**I want to** ユーザーの回答を正確に記録する  
**So that** 後で集計できる

#### 受け入れ基準
- [ ] ユーザーが選択肢を選んで回答ボタンをクリックした時点で回答を記録
- [ ] 記録する情報:
  - セッションID（ユーザー識別）
  - 問題ID
  - 選択した選択肢
  - 回答時刻（タイムスタンプ）
  - 正解/不正解
- [ ] 同じ問題への複数回答は受け付けない（初回のみ有効）
- [ ] 回答データの永続化

#### 技術的考慮事項
- データベース設計: 回答テーブル
- トランザクション処理で重複回答を防止
- インデックスの最適化（高速な集計のため）

---

### US-004-02: 回答時間の計測
**As a** system  
**I want to** 問題表示から回答までの時間を計測する  
**So that** ランキングのソートに使用できる

#### 受け入れ基準
- [ ] 問題が表示された時刻を記録（開始時刻）
- [ ] ユーザーが回答した時刻を記録（終了時刻）
- [ ] 回答時間 = 終了時刻 - 開始時刻（ミリ秒単位）
- [ ] 回答時間を回答データと共に保存
- [ ] 未回答の場合、回答時間は記録しない（または最大値を設定）

#### 技術的考慮事項
- サーバー時刻を基準とする（クライアント時刻は信頼しない）
- タイムゾーンの考慮
- 問題表示イベントと回答イベントの紐付け

---

### US-004-03: ピリオドごとの合計回答時間の計算
**As a** system  
**I want to** ピリオド内の全回答時間を合計する  
**So that** ピリオドランキングを作成できる

#### 受け入れ基準
- [ ] ピリオド終了時に各ユーザーの合計回答時間を計算
- [ ] 合計回答時間 = ピリオド内の全問題の回答時間の合計
- [ ] 未回答問題の時間は合計に含めない（または扱いを明確化）
- [ ] 計算結果を保存

#### 技術的考慮事項
- SQL集計クエリの最適化
- リアルタイム集計 vs バッチ集計の検討

---

### US-004-04: 全ピリオドを通じた合計回答時間の計算
**As a** system  
**I want to** 全ピリオドの回答時間を合計する  
**So that** 最終ランキングを作成できる

#### 受け入れ基準
- [ ] 全ピリオド終了時に各ユーザーの全体合計回答時間を計算
- [ ] 全体合計回答時間 = 全ピリオドの回答時間の総和
- [ ] 計算結果を保存

---

### US-004-05: 未回答の処理
**As a** system  
**I want to** adminが次の画面に進んだ時点で未回答を締め切る  
**So that** 公平にクイズを進行できる

#### 受け入れ基準
- [ ] adminが「正解発表へ」ボタンをクリックした時点で回答を締め切る
- [ ] 締切後の回答は受け付けない
- [ ] 未回答のユーザーには不正解として記録する（正解数に含めない）
- [ ] **未回答の場合、回答時間はadmin側でクイズ表示からクイズ締め切りまでの時間を使用**

#### 技術的考慮事項
- 問題ごとの状態管理（回答受付中/締切）
- クライアント側での回答ボタンの無効化
- サーバー側での締切チェック

---

## 非機能要件
- **正確性**: 回答時間の計測誤差を最小化（ネットワーク遅延を考慮）
- **パフォーマンス**: 120人の同時回答を遅延なく処理
- **データ整合性**: 回答データの重複や欠損を防ぐ

## 依存関係
- 001 ユーザー参加とセッション管理
- 002 クイズとピリオドの管理
- 003 画面遷移制御

## 備考
- ネットワーク遅延を考慮した時間補正アルゴリズムの検討
- 不正防止のためクライアント時刻は使用しない
